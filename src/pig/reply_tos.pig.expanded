register '/me/pig/build/ivy/lib/Pig/avro-1.5.3.jar';
register '/me/pig/build/ivy/lib/Pig/json-simple-1.1.jar';
register '/me/pig/contrib/piggybank/java/piggybank.jar';
register '/me/pig/build/ivy/lib/Pig/jackson-core-asl-1.7.3.jar';
register '/me/pig/build/ivy/lib/Pig/jackson-mapper-asl-1.7.3.jar';
define AvroStorage org.apache.pig.piggybank.storage.avro.AvroStorage();
define MongoStorage com.mongodb.hadoop.pig.MongoStorage();
set aggregate.warning true
rmf /tmp/reply_tos.avro
avro_emails = load '/me/tmp/thu_emails' USING AvroStorage();
avro_emails = filter avro_emails BY (froms IS not null);
split avro_emails INTO macro_from_to_pairs_has_reply_tos_0 IF reply_tos IS not null, macro_from_to_pairs_just_froms_0 IF reply_tos IS null;
macro_from_to_pairs_with_reply_tos_0 = foreach macro_from_to_pairs_has_reply_tos_0 generate reply_tos AS froms, tos, ccs, bccs, message_id, in_reply_to;
macro_from_to_pairs_reply_to_froms_0 = foreach macro_from_to_pairs_has_reply_tos_0 generate froms, tos, ccs, bccs, message_id, in_reply_to;
macro_from_to_pairs_just_froms_0 = foreach macro_from_to_pairs_just_froms_0 generate froms, tos, ccs, bccs, message_id, in_reply_to;
macro_from_to_pairs_combined_emails_0 = union macro_from_to_pairs_with_reply_tos_0, macro_from_to_pairs_reply_to_froms_0, macro_from_to_pairs_just_froms_0;
macro_from_to_pairs_just_tos_0 = foreach macro_from_to_pairs_combined_emails_0 generate flatten(froms.(address))  AS from, flatten(tos.(address))  AS to, message_id, in_reply_to;
macro_from_to_pairs_just_ccs_0 = foreach macro_from_to_pairs_combined_emails_0 generate flatten(froms.(address))  AS from, flatten(ccs.(address))  AS to, message_id, in_reply_to;
macro_from_to_pairs_just_bccs_0 = foreach macro_from_to_pairs_combined_emails_0 generate flatten(froms.(address))  AS from, flatten(bccs.(address))  AS to, message_id, in_reply_to;
pairs = union macro_from_to_pairs_just_tos_0, macro_from_to_pairs_just_ccs_0, macro_from_to_pairs_just_bccs_0;
store pairs INTO '/tmp/pairs_test';
